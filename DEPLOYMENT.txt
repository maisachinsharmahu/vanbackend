# CI/CD Pipeline Setup Guide

## Quick Setup Checklist

Use this checklist to track your progress:

- [x] SSH key generated on VM (`/home/vibro_in/.ssh/gcp_deploy_key`)
- [ ] Public key added to `~/.ssh/authorized_keys`
- [ ] GitHub Secret: `GCP_SSH_PRIVATE_KEY` configured
- [ ] GitHub Secret: `GCP_VM_IP` configured  
- [ ] GitHub Secret: `GCP_VM_USER` configured (value: `vibro_in`)
- [ ] GitHub Secret: `PROJECT_PATH` configured (value: `/home/vibro_in/revenuebackend/vanbackend`)
- [ ] Node.js and PM2 installed on VM
- [ ] `.env` file created with all environment variables
- [ ] Application running with PM2
- [ ] PM2 startup configured for auto-restart
- [ ] Test deployment by pushing to `stage` branch

## Overview
This pipeline automatically deploys your backend to Google Cloud VM whenever you push changes to the `stage` branch.

## Prerequisites
- GitHub repository with your code ✅
- Google Cloud VM instance running ✅
- SSH access to the VM ✅
- PM2 installed on the VM (see setup steps below)

## Setup Steps

### 1. SSH Key Setup (ALREADY COMPLETED ✅)

You've already generated the SSH key pair on your VM at:
- Private key: `/home/vibro_in/.ssh/gcp_deploy_key`
- Public key: `/home/vibro_in/.ssh/gcp_deploy_key.pub`
- Fingerprint: `SHA256:kZm5x/yy4sidrknsOHwOvBqL6ynVhlavjCJ3Hp+dwOU`

If you need to generate a new key pair in the future:
```bash
ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/gcp_deploy_key
```

### 2. Add Public Key to VM (ALREADY ON VM ✅)

Since you generated the key ON your VM, the public key is already there.
Just ensure it's in the authorized_keys file:

```bash
# On your VM (you're already logged in as vibro_in)
cat ~/.ssh/gcp_deploy_key.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

Verify it was added:
```bash
cat ~/.ssh/authorized_keys
```

### 3. Configure GitHub Secrets

Go to your GitHub repository → Settings → Secrets and variables → Actions → New repository secret

**Direct link**: https://github.com/maisachinsharmahu/vanbackend/settings/secrets/actions

Add these secrets:

| Secret Name | Value to Use | How to Get It |
|-------------|--------------|---------------|
| `GCP_SSH_PRIVATE_KEY` | Content of private key file | Run on VM: `cat /home/vibro_in/.ssh/gcp_deploy_key` |
| `GCP_VM_IP` | Your VM's external IP | Check GCP Console or run: `curl ifconfig.me` |
| `GCP_VM_USER` | `vibro_in` | Your current username on the VM |
| `PROJECT_PATH` | `/home/vibro_in/revenuebackend/vanbackend` | Full path to your project |

**To get the private key content:**
```bash
# On your VM
cat /home/vibro_in/.ssh/gcp_deploy_key
```

Copy the ENTIRE output including:
- `-----BEGIN OPENSSH PRIVATE KEY-----`
- All the content in between
- `-----END OPENSSH PRIVATE KEY-----`

Paste this entire block into the `GCP_SSH_PRIVATE_KEY` secret.

### 4. Setup VM Environment

Your project is already on the VM at: `/home/vibro_in/revenuebackend/vanbackend`

**OPTION A: Automated Setup (Recommended)**

Run the automated setup script on your VM:

```bash
cd /home/vibro_in/revenuebackend/vanbackend
chmod +x vm-setup.sh
./vm-setup.sh
```

This script will automatically:
- Add public key to authorized_keys
- Install Node.js and PM2 (if needed)
- Install dependencies
- Start the application with PM2
- Configure PM2 startup

**OPTION B: Manual Setup**

Verify and complete the setup manually:

```bash
# Check if Node.js is installed
node --version
npm --version

# If not installed, install Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# Install PM2 globally (if not already installed)
sudo npm install -g pm2

# Navigate to your project
cd /home/vibro_in/revenuebackend/vanbackend

# Ensure you're on the stage branch
git checkout stage
git pull origin stage

# Install dependencies
npm install

# Verify .env file exists with all required variables
ls -la .env
# If missing, create it:
nano .env

# Start the application with PM2
pm2 start src/server.js --name atlas-backend

# Save PM2 configuration to auto-start on reboot
pm2 save
pm2 startup
# Follow the instructions from the output (copy-paste the command it shows)

# Check application status
pm2 status
pm2 logs atlas-backend --lines 20
```

### 5. Test the Pipeline

1. Make a change to your code
2. Commit and push to the `stage` branch:
```bash
git checkout stage
git add .
git commit -m "Test deployment pipeline"
git push origin stage
```

3. Go to GitHub → Actions tab to watch the deployment

### 6. Manual Deployment (Optional)

You can also deploy manually using the deployment script:

```bash
# On your VM
cd /path/to/your/project
chmod +x deploy.sh
./deploy.sh
```

Or with custom settings:
```bash
PROJECT_DIR=/custom/path BRANCH=stage APP_NAME=my-app ./deploy.sh
```

## Pipeline Workflow

1. **Trigger**: Push to `stage` branch
2. **Checkout**: GitHub Actions checks out the code
3. **SSH Setup**: Configures SSH connection to VM
4. **Deploy**: 
   - Connects to VM via SSH
   - Pulls latest code from `stage` branch
   - Installs dependencies
   - Restarts application with PM2
5. **Verify**: Checks application status
6. **Cleanup**: Removes SSH keys from runner

## Monitoring

### Check Application Status
```bash
pm2 status
```

### View Logs
```bash
pm2 logs atlas-backend
pm2 logs atlas-backend --lines 100
```

### Restart Application
```bash
pm2 restart atlas-backend
```

### Stop Application
```bash
pm2 stop atlas-backend
```

## Troubleshooting

### SSH Connection Failed
- Verify `GCP_VM_IP` is correct and VM is running
- Check that public key is in `~/.ssh/authorized_keys` on VM
- Ensure VM firewall allows SSH (port 22)

### Deployment Failed
- Check GitHub Actions logs for specific error
- Verify `PROJECT_PATH` secret is correct
- Ensure VM has enough disk space: `df -h`
- Check PM2 logs: `pm2 logs atlas-backend --err`

### Application Not Starting
- Check environment variables in `.env` file
- Verify MongoDB connection string
- Check port availability: `sudo lsof -i :3000`
- Review PM2 logs: `pm2 logs atlas-backend`

### Permission Issues
- Ensure deployment script is executable: `chmod +x deploy.sh`
- Check file ownership: `ls -la`
- Verify user has write permissions to project directory

## Environment Variables

Make sure your VM has a `.env` file with all required variables:

```env
# Server
PORT=3000
NODE_ENV=production

# Database
MONGODB_URI=your_mongodb_connection_string

# JWT
JWT_SECRET=your_jwt_secret
JWT_EXPIRE=7d

# Google Cloud Storage
GCS_BUCKET_NAME=your_bucket_name
GCS_PROJECT_ID=your_project_id
GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account-key.json

# Other configurations
CORS_ORIGIN=https://your-frontend-domain.com
```

## Security Best Practices

1. **Never commit secrets** - Use `.env` file and add it to `.gitignore`
2. **Use GitHub Secrets** - Store all sensitive data in GitHub Secrets
3. **Rotate SSH keys** - Periodically update SSH keys
4. **Limit SSH access** - Use firewall rules to restrict SSH access
5. **Use HTTPS** - Configure SSL/TLS for your application
6. **Keep dependencies updated** - Regularly run `npm audit` and update packages

## Additional Features

### Add Slack/Discord Notifications

Add this step to `.github/workflows/deploy-stage.yml`:

```yaml
- name: Notify deployment
  if: always()
  run: |
    curl -X POST -H 'Content-type: application/json' \
    --data '{"text":"Deployment to stage: ${{ job.status }}"}' \
    ${{ secrets.SLACK_WEBHOOK_URL }}
```

### Add Health Check

Add after deployment:

```yaml
- name: Health check
  run: |
    sleep 10
    curl -f http://${{ secrets.GCP_VM_IP }}:3000/health || exit 1
```

### Backup Before Deployment

Add to deployment script:

```bash
# Create backup
BACKUP_DIR="/home/$(whoami)/backups"
mkdir -p $BACKUP_DIR
tar -czf $BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz .
```

## Support

For issues or questions:
1. Check GitHub Actions logs
2. Review PM2 logs on VM
3. Verify all secrets are correctly set
4. Ensure VM has internet connectivity
